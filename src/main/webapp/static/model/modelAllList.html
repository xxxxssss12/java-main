<!DOCTYPE html>
<html>
<head>
    <title>模具总表信息</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="../tools/ligerUI/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="../tools/ligerUI/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <script src="../js/jquery-1.7.2.min.js"></script>
    <script src="../tools/ligerUI/ligerUI/js/ligerui.all.min.js"></script>
    <script src="../js/common.js"></script>
    <style type="text/css">
        .font-yahei {
            font-family: "Microsoft YaHei UI";
        }
    </style>
</head>
<body>
<div id="form1" class="liger-form">
    <div class="fields">
        <input data-type="text" data-label="图号" data-name="q_modelNo" />
        <div data-type="select" data-label="类型" data-name="q_modelType" data-newline="false">
            <input class="editor"  data-textField="name" data-valueField="id"/>
        </div>
        <input data-type="text" data-label="存放位置" data-name="q_storeLocation" data-newline="true" />

        <input data-type="text" data-label="备注" data-name="q_remark" data-newline="false" />

    </div>
</div>
<button type="button" id="query" class="l-button l-button-submit">查询</button>
<div id="modelAllGrid"></div>
    <script>
        var modelAllGrid;
        var modelTypes = [{"id":1,"name":"中开泵"},{"id":2,"name":"中开泵RS"},{"id":3,"name":"中开泵sa"},{"id":4,"name":"中开泵sap"},{"id":5,"name":"中开泵slaz"},{"id":6,"name":"军工泵"},{"id":7,"name":"冷凝泵"},{"id":8,"name":"挖泥泵"},{"id":9,"name":"斜流泵"},{"id":10,"name":"杂泵老泵"},{"id":11,"name":"标准件"},{"id":12,"name":"核泵"},{"id":13,"name":"沅江泵YJ"},{"id":14,"name":"沅江泵YJG"},{"id":15,"name":"湘江泵"},{"id":16,"name":"湘阴泵"},{"id":17,"name":"美国泵"},{"id":18,"name":"老泵杂泵"},{"id":19,"name":"脱硫泵"},{"id":20,"name":"风能"}];
        var modelTypeLiger;
        var saveFlag = false;
        $(function() {
            modelTypeLiger = liger.get('q_modelType');
            modelAllGrid = $("#modelAllGrid").ligerGrid({
                columns:[
                    {type:'lable',name:"modelNo", display:"图号", width:"200"},
                    {type:'lable',name:"name", display:"名称", width:"90",
                        editor:  {
                            type:"text"
                        }
                    },
                    {type:'lable', name:"modelTypeId", display:"类型", width:"90",
                        render: function(row) {
                            if (row.modelTypeId) {
                                return modelTypes[row.modelTypeId-1].name
                            }
                        },
                        editor:  {
                            type:"select", data:modelTypes, valueField: "id", textField: "name"
                        }
                    },
                    {type:'lable', name:"storeLocation", display:"存放位置",
                        editor:  {
                            type:"text"
                        }
                    },
                    {type:'lable', name:"lingjiancaizhi", display:"零件材质",
                        editor:  {
                            type:"text"
                        }
                    },
                    {type:'lable', name:"createTime", display:"制造时间",
                        render:function(row) {
                            if (row.createTime) {
                                return row.createTime.substr(0, 10);
                            } else {
                                return "";
                            }
                        }
                    },
                    {type:'lable', name:"createLocation", display:"制造地点",
                        editor:  {
                            type:"text"
                        }
                    },
                    {type:'lable', name:"remark", display:"备注",
                        editor: {
                            type:"text"
                        }
                    },
                    {type:'lable', name:"operator", display:"操作", width: '300px',
                        render: function (row) {
                            var updownRecord = "<a href='javascript:showUpdownRecord(" + row.id + ")'>上下场记录</a>";
                            var borrowRecord = "<a href='javascript:showBorrowRecord(" + row.id + ")'>借出记录</a>";
                            var showDetail = "<a href='javascript:showDetail(" + row.id + ")'>查看明细</a>";
                            var del = "<a href='javascript:del(" + row.id + ")'>删除</a>";
                            return updownRecord + "&nbsp" + borrowRecord + "&nbsp" + showDetail + "&nbsp;" + del;
                        }
                    }
                ],
                toolbar:{
                    items:[
                        {text: '新增', click: add, icon: 'add' },
                        {line: true },
                        {text: '批量保存', click: save, icon: 'edit' },
                        {line: true },
                    ]
                },
                url:baseUrl + "modelAll/getByPage",
                enabledEdit: true,clickToeditor: true, isScroll: false,
                width: '100%'
            })
            $("#query").click(function() {
                modelAllGrid.set({
                    url:baseUrl + "modelAll/getByPage?modelNo=" + $("input[ligeruiid=q_modelNo]").val()
                                + "&modelTypeId=" + modelTypeLiger.selectedValue
                                + "&remark=" + $("input[ligeruiid=q_remark]").val()
                                + "&storeLocation=" + $("input[ligeruiid=q_storeLocation]").val()
                });
                modelAllGrid.changePage('first');
            })
            $.ajax({
                url: baseUrl + "modelAll/getAllType",
                type: "get",
                dataType: "json",
                success: function(ri) {
                    if (ri && ri.code && ri.code>0) {
                        modelTypes = ri.data;
                        modelTypeLiger.set("data", modelTypes);
                    }
                }
            })
        });
        var add = function () {
            $.ligerDialog.open({title:"新增模具",url:"addModel.html",width:700,height:500,showMax:true,
                onClose: function() {
                    detailGrid.loadData(true);
                }
            });
        }
        var refresh= function() {
            modelAllGrid.loadData(true);
        }
        var save = function() {
            if (saveFlag) {
                $.ligerDialog.warn("已经有保存在进行中，请稍后再试");
                return;
            }
            var changes = modelAllGrid.getUpdated();
            if (!changes || changes.length <= 0) {
                $.ligerDialog.warn("没有数据需要更新");
                return;
            }
            saveFlag = true;
            $.ajax({
                url : baseUrl + "modelAll/batchUpdate",
                type: "post",
                data: {
                    "modelAllListJson": JSON.stringify(changes)
                },
                dataType: "json",
                success: function(ri) {
                    if (ri && ri.code > 0) {
                        $.ligerDialog.success("保存成功");
                        modelAllGrid.loadData(true);
                    } else {
                        $.ligerDialog.error(ri.message);
                    }
                    saveFlag = false;
                },
                error: function() {
                    $.ligerDialog.error("系统发生异常");
                    saveFlag = false;
                }
            })
        }
        var showDetail = function(modelId) {
            parent.f_addTab("模具明细", "模具明细", "model/modelDetailList.html?modelId=" + modelId);
        }
        var showUpdownRecord = function(modelId) {
            parent.f_addTab("上下场记录", "上下场记录", "model/modelUpdownList.html?modelId=" + modelId);
        }
        var showBorrowRecord = function(modelId) {
            parent.f_addTab("借出记录", "借出记录", "model/modelBorrowList.html?modelId=" + modelId);
        }
        var del = function(modelId) {
            if (!modelId || modelId <= 0) {
                $.ligerDialog.warn("id异常");
                return;
            }
            $.ligerDialog.confirm("确定删除？", function(yes) {
                if (yes) {

                    $.ajax({
                        url: baseUrl + "modelAll/delete",
                        type: "post",
                        data: {
                            "id": modelId
                        },
                        dataType: "json",
                        success: function(ri) {
                            if (ri && ri.code > 0) {
                                $.ligerDialog.success("删除成功");
                                modelAllGrid.loadData(true);
                            } else {
                                $.ligerDialog.error(ri.message);
                            }
                        },
                        error: function() {
                            $.ligerDialog.error("系统发生异常");
                        }
                    });
                }
            })
        }
    </script>
</body>
</html>